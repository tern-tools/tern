# Copyright (c) 2019 VMware, Inc. All Rights Reserved.
# SPDX-License-Identifier: BSD-2-Clause

version: 2.1
# set up executor
executors:
  ubuntu1604:
    machine:
      image: ubuntu-1604:201903-01

commands:
  setup:
    steps:
      - run: sudo apt-get install -y attr
      - checkout
      - run: pyenv global 3.6.5
      - run: pip install --upgrade pip
  create_pypirc:
    steps:
      - run:
          name: Create pypirc file
          command: |
           echo -e "[pypi]" >> ~/.pypirc
           echo -e "username = $R_PYPI_UN" >> ~/.pypirc
           echo -e "password = $PYPI_PW" >> ~/.pypiruc

jobs:
 # Run these tests for PRs
  prjobs:
    executor: ubuntu1604
    steps:
      - setup # install dependencies and set python global environment
      - run: pip install -r dev-requirements.txt # install python dependencies
      - run: pip install . # install codebase
      - run: c=`python ci/evaluate_docs.py`; if [ -z $c ]; then echo "No .py files to lint"; else echo $c | xargs prospector; fi # run prospector
      - run: c=`python ci/evaluate_docs.py`; if [ -z $c ]; then echo "No .py files to lint"; else echo $c | xargs bandit; fi # run bandit
      - run: python ci/test_commit_message.py # check if commit message follows project guidelines
      - run: python ci/test_files_touched.py # run tests based on changes in PR
  # Deploy to PyPi
  pypi_deploy:
   executor: ubuntu1604
   steps:
      - setup
      - run: pip install .
      - run: pip install twine
      - run: pip install wheel
      # make sure git tag matches release version
      - run: python setup.py verify
      - create_pypirc 
      - run: python setup.py sdist bdist_wheel upload

workflows:
  version: 2
  PRs:
    jobs:
      - prjobs
  Release:
    jobs:
      - pypi_deploy:
          filters:
            # ignore all commits on any branch by default
            branches:
              ignore: /.*/
            # only run on version tags
            tags:
              only: /^v[0-9]+(\.[0-9]+)*$/
